# KnowledgeAI â€” Endâ€‘toâ€‘End Setup & User Guide (Backend + Frontend Chat)

This is the **single source of truth** to set up KnowledgeAI on a fresh machine, prepare the RAG data, run the backend API, and launch the **frontend chat** UI. It captures all the practical gotchas we hit while bringing the stack up on macOS.

---

## ğŸ“‘ Table of Contents
1. [What You Get](#what-you-get)  
2. [Architecture at a Glance](#architecture-at-a-glance)  
3. [Directory Structure](#directory-structure)  
4. [Prerequisites](#prerequisites)  
5. [Python Backend Setup](#python-backend-setup)  
6. [RAG Data Prep & Pipeline](#rag-data-prep--pipeline)  
7. [Start the Backend API](#start-the-backend-api)  
8. [Frontend (Vite + React + Tailwind)](#frontend-vite--react--tailwind)  
9. [Run the Chat Endâ€‘toâ€‘End](#run-the-chat-end-to-end)  
10. [Scripts Reference](#scripts-reference)  
11. [Troubleshooting](#troubleshooting)  
12. [Cheatsheet](#cheatsheet)

---

## âœ… What You Get

- A **document pipeline** (extract â†’ caption images â†’ chunk â†’ embed to Chroma).
- **Four agents** (RCA, SOP, Ticket, Super) you can run locally via FastAPI.
- A **simple chat UI** (Vite + React + Tailwind) that talks to the backend `POST /chat` endpoint.

---

## ğŸ§© Architecture at a Glance

- **Pipeline** (Python): `scripts/pipeline.py` orchestrates:
  - `scripts/extract_and_caption.py` â†’ uses *unstructured* + BLIP to parse docs & caption images.
  - `scripts/embed.py` â†’ builds Chroma vector DB with SBERT (`BAAI/bge-base-en`).
- **Agents** (Python/FastAPI): live under `scripts/agents/`; helper in `scripts/agents/shared.py`.
- **Backend API** (Python/FastAPI): `backend/main.py`, route mounted in `backend/routes/chat.py` exposes `POST /chat`.
- **Frontend** (Vite/React/Tailwind): under `frontend/`. The UI posts to `/chat` (Vite proxy â†’ backend).

---

## ğŸ“‚ Directory Structure

```
KnowledgeAI/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ logs/
â”‚   â”‚   â””â”€â”€ chat.log                 # created/used by backend chat route
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ chat.py                  # POST /chat
â”‚   â””â”€â”€ main.py                      # FastAPI app (imports routes, CORS, etc.)
â”œâ”€â”€ clean/                           # optional exports
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ Chat.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatBubble.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ChatInput.tsx
â”‚   â”‚   â”œâ”€â”€ pages/App.tsx
â”‚   â”‚   â”œâ”€â”€ styles/index.css
â”‚   â”‚   â”œâ”€â”€ utils/api.ts
â”‚   â”‚   â””â”€â”€ main.tsx
â”‚   â”œâ”€â”€ .env                         # (optional) front-end overrides
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ postcss.config.cjs
â”‚   â”œâ”€â”€ tailwind.config.js
â”‚   â””â”€â”€ vite.config.ts               # includes proxy for /chat â†’ http://127.0.0.1:8000
â”œâ”€â”€ logs/
â”œâ”€â”€ raw/                             # put your source documents here
â”œâ”€â”€ raw_imgs/                        # extracted images
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ rca_agent.py
â”‚   â”‚   â”œâ”€â”€ sop_agent.py
â”‚   â”‚   â”œâ”€â”€ ticket_agent.py
â”‚   â”‚   â”œâ”€â”€ super_agent.py
â”‚   â”‚   â””â”€â”€ shared.py
â”‚   â”œâ”€â”€ assistants/                  # helper utilities
â”‚   â”œâ”€â”€ extract_and_caption.py
â”‚   â”œâ”€â”€ embed.py
â”‚   â”œâ”€â”€ verify_embeddings.py
â”‚   â”œâ”€â”€ check_embedding_progress.py
â”‚   â”œâ”€â”€ tools_rag.py
â”‚   â””â”€â”€ pipeline.py
â”œâ”€â”€ vector_store/                    # Chroma DB
â”œâ”€â”€ agents_start.sh / agents_stop.sh / agents_test.sh
â”œâ”€â”€ requirements.txt
â””â”€â”€ .env                             # backend/agents environment
```

---

## ğŸ§° Prerequisites

- **macOS** (Apple Silicon OK) or Linux/WSL  
- **Python 3.11** recommended  
- **Node.js 18+** (Node 20+ recommended) and `npm`  
- **Git**  
- OpenAI API key (only if you intend to call OpenAI; the chat route can also use local answers, depending on your code path)

---

## ğŸ Python Backend Setup

1. **Create & activate venv**
   ```bash
   cd KnowledgeAI
   python3 -m venv .venv
   source .venv/bin/activate
   python -m pip install --upgrade pip wheel setuptools
   ```

2. **Install Python deps**
   ```bash
   pip install -r requirements.txt

   # Extras used by unstructured for Office docs
   pip install "unstructured[docx]" "unstructured[xlsx]" "unstructured[pptx]"
   ```

3. **System packages (macOS)**
   ```bash
   brew install imagemagick ghostscript poppler tesseract ffmpeg cmake
   brew install --cask libreoffice
   ```

4. **Backend env (.env at repo root)**
   ```env
   # === Backend / RAG ===
   VECTOR_STORE_PATH=./vector_store

   # === Logging ===
   LOG_LEVEL=INFO
   TOKENIZERS_PARALLELISM=false
   HF_HUB_DISABLE_TELEMETRY=1

   # === LLM (optional) ===
   OPENAI_API_KEY=
   ```

---

## ğŸ“¦ RAG Data Prep & Pipeline

1. Place documents in `raw/` (`.pptx`, `.docx`, `.xlsx`, `.pdf`, `.txt`, images).
2. Build vectors:
   ```bash
   python -m scripts.pipeline all
   ```
   - First run will download HF models (BLIP + SBERT). If you use Cloudflare WARP/corp VPN and hit SSL issues, temporarily disable it.

---

## ğŸš€ Start the Backend API

1. Ensure the backend log directory exists **once**:
   ```bash
   mkdir -p backend/logs
   ```
2. Launch API:
   ```bash
   uvicorn backend.main:app --reload --port 8000
   ```
   - FastAPI will serve on `http://127.0.0.1:8000`.
   - `backend/routes/chat.py` appends to `backend/logs/chat.log` (created automatically if the directory exists).

---

## ğŸ’» Frontend (Vite + React + Tailwind)

> The UI posts to `/chat`. Viteâ€™s dev server proxies `/chat` â†’ `http://127.0.0.1:8000` (see `vite.config.ts`).  
> **Therefore, start the backend first** to avoid `ECONNREFUSED` at the proxy.

1. **Install Node deps**
   ```bash
   cd frontend
   npm ci         # or: npm install
   ```

2. **(Optional) Frontend .env**  
   If you want to override the default proxy/URLs, create `frontend/.env`:
   ```env
   # example â€” only if you changed backend port/host
   VITE_BACKEND_URL=http://127.0.0.1:8000
   ```
   Ensure `utils/api.ts` reads this if present; otherwise the proxy handles `/chat`.

3. **Run the dev server**
   ```bash
   npm run dev
   ```
   - Vite opens `http://localhost:5173`.
   - When you send a message, the UI sends `POST /chat` which the dev proxy forwards to `http://127.0.0.1:8000/chat`.

4. **Build for production**
   ```bash
   npm run build
   npm run preview  # optional local preview
   ```

---

## ğŸ”— Run the Chat Endâ€‘toâ€‘End

1. Terminal A (repo root):
   ```bash
   source .venv/bin/activate
   uvicorn backend.main:app --reload --port 8000
   ```
2. Terminal B:
   ```bash
   cd frontend
   npm run dev
   ```
3. Open the browser at `http://localhost:5173`, type in the chat box, and hit **Enter**.  
   Check `backend/logs/chat.log` for request/response traces.

---

## ğŸ“œ Scripts Reference

**Pipeline**
- `python -m scripts.pipeline all` â€” endâ€‘toâ€‘end doc processing
- `scripts/extract_and_caption.py` â€” unstructured + BLIP captions
- `scripts/embed.py` â€” Chroma embeddings
- `scripts/verify_embeddings.py`, `scripts/check_embedding_progress.py` â€” diagnostics

**Agents (optional)**
- `./agents_start.sh` â€” start RCA/SOP/Ticket/Super on ports 9131/9132/9133/9191
- `./agents_stop.sh`, `./agents_test.sh`

**Backend**
- `backend/main.py` â€” FastAPI app
- `backend/routes/chat.py` â€” `POST /chat` handler + logging

**Frontend**
- `frontend/src/components/Chat.tsx`, `ChatBubble.tsx`, `ChatInput.tsx`
- `frontend/src/utils/api.ts` â€” HTTP client
- `frontend/vite.config.ts` â€” dev proxy for `/chat`

---

## ğŸ§¯ Troubleshooting

**1) Vite â€œhttp proxy error: /chat ECONNREFUSEDâ€**  
Cause: Backend isnâ€™t running or wrong port.  
Fix:
```bash
uvicorn backend.main:app --reload --port 8000
# verify: curl -i http://127.0.0.1:8000/docs
```

**2) 500 from /chat â€“ FileNotFoundError for `backend/logs/chat.log`**  
Cause: Directory missing on first run.  
Fix:
```bash
mkdir -p backend/logs
# restart uvicorn
```

**3) Unstructured errors (PPTX/DOCX/XLSX)**  
- `PackageNotFoundError` â†’ file missing/misnamed in `raw/`.
- â€œnot a ZIP archiveâ€ â†’ re-save the DOCX in Word/LibreOffice.
- Install extras:  
  `pip install "unstructured[docx]" "unstructured[xlsx]" "unstructured[pptx]"`

**4) SSL errors when downloading models**  
Disable Cloudflare WARP / corp VPN temporarily or configure your CA bundle.

**5) CORS errors (in production without Vite proxy)**  
Expose the backend with proper CORS in `backend/main.py` or use a reverse proxy (Nginx/Caddy) to forward `/chat`.

---

## ğŸ—’ï¸ Cheatsheet

```bash
# One-time
python3 -m venv .venv
source .venv/bin/activate
python -m pip install --upgrade pip wheel setuptools
pip install -r requirements.txt
pip install "unstructured[docx]" "unstructured[xlsx]" "unstructured[pptx]"
brew install imagemagick ghostscript poppler tesseract ffmpeg cmake
brew install --cask libreoffice

# Data â†’ vectors
mkdir -p raw backend/logs
python -m scripts.pipeline all

# Backend
uvicorn backend.main:app --reload --port 8000

# Frontend
cd frontend
npm ci
npm run dev
```

---

If you hit a new edge case, open an issue with the failing command, full stack trace, and OS/Node/Python versions. Happy shipping! ğŸš€